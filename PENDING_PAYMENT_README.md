# نظام الدفع المعلق (Pending Payment System)

## المشاكل التي تم حلها:

### 1. **مشكلة عدم ظهور الطلبات المعلقة**
- **المشكلة**: عند الخروج من عملية الدفع، كان الطلب يختفي تماماً
- **الحل**: إنشاء جميع الطلبات فوراً بحالة "pending" قبل بدء عملية الدفع

### 2. **مشكلة عدم وجود مهلة زمنية للدفع**
- **المشكلة**: الطلبات المعلقة كانت تبقى إلى الأبد بدون دفع
- **الحل**: إضافة مهلة 48 ساعة للدفع مع إلغاء تلقائي للطلبات المنتهية الصلاحية

### 3. **مشكلة عدم دعم جميع طرق الدفع**
- **المشكلة**: كان النظام يدعم الطلبات المعلقة لفوري فقط
- **الحل**: دعم جميع طرق الدفع (بطاقات ائتمانية، فوري، محافظ إلكترونية)

## كيفية عمل النظام الجديد:

### تدفق الطلب:
1. **إنشاء الطلب فوراً**: عند الضغط على "إتمام الطلب"، يتم إنشاء الطلب بحالة "pending"
2. **عرض معلومات الدفع**: يتم عرض معلومات الدفع المطلوبة حسب طريقة الدفع
3. **مهلة 48 ساعة**: لدى المستخدم 48 ساعة لإتمام الدفع
4. **إلغاء تلقائي**: إذا لم يتم الدفع خلال 48 ساعة، يتم إلغاء الطلب تلقائياً وإرجاع المخزون

### حالات الطلب:
- **pending**: الطلب في انتظار الدفع (لمدة 48 ساعة)
- **confirmed**: تم تأكيد الدفع بنجاح
- **cancelled**: تم إلغاء الطلب (إما يدوياً أو تلقائياً)
- **processing**: قيد المعالجة
- **shipped**: تم الشحن
- **delivered**: تم التسليم

## الملفات المُحدثة:

### 1. **CheckoutPage.js** (الفرونت اند)
- تعديل تدفق الـ checkout لإنشاء الطلبات فوراً
- إضافة توجيه لصفحة الطلبات بعد إنشاء الطلب
- تحسين معالجة طرق الدفع المختلفة

### 2. **OrderPage.js** (الفرونت اند)
- إضافة عرض معلومات الدفع المعلق لجميع طرق الدفع
- إضافة عداد زمني لانتهاء صلاحية الدفع
- تحسين عرض حالة الطلبات المعلقة

### 3. **CheckoutController.php** (البيك اند)
- إنشاء controller كامل لمعالجة الـ checkout
- إضافة منطق إنشاء الطلبات بحالة pending
- إضافة مهلة زمنية للدفع (48 ساعة)
- إضافة دالة إلغاء الطلبات المنتهية الصلاحية

### 4. **CancelExpiredOrders.php** (البيك اند)
- أمر console لإلغاء الطلبات المنتهية الصلاحية
- إرجاع المخزون تلقائياً عند الإلغاء
- معالجة الأخطاء بشكل آمن

## طرق الدفع المدعومة:

1. **cod** - الدفع عند الاستلام (يتم تأكيده فوراً)
2. **credit_card** - البطاقات الائتمانية (Paymob)
3. **fawry** - فوري (كود دفع للمكينات)
4. **wallet** - المحافظ الإلكترونية (فودافون كاش وأخواتها)

## التثبيت والإعداد:

### 1. **تشغيل الأمر التلقائي لإلغاء الطلبات**
```bash
# يدوياً
php artisan orders:cancel-expired

# أو إضافة للـ scheduler (app/Console/Kernel.php)
protected function schedule(Schedule $schedule)
{
    $schedule->command('orders:cancel-expired')->hourly();
}
```

### 2. **إعداد قاعدة البيانات**
تأكد من وجود الجداول التالية:
- `orders` مع الأعمدة: `expires_at` (timestamp)
- `order_items`
- `payments`

### 3. **إعداد Models**
```php
// Order.php
class Order extends Model
{
    protected $fillable = [
        'user_id', 'order_number', 'total', 'status',
        'payment_method', 'expires_at', /* ... other fields */
    ];

    protected $dates = ['expires_at'];

    public function orderItems()
    {
        return $this->hasMany(OrderItem::class);
    }

    public function payment()
    {
        return $this->hasOne(Payment::class);
    }
}
```

## كيفية الاختبار:

### 1. **اختبار الطلبات المعلقة**
```bash
# إنشاء طلب بطريقة دفع إلكترونية
# التحقق من ظهور الطلب في قائمة الطلبات بحالة "pending"
```

### 2. **اختبار الإلغاء التلقائي**
```bash
# تعديل تاريخ expires_at ليكون في الماضي
# تشغيل الأمر: php artisan orders:cancel-expired
# التحقق من تغيير حالة الطلب إلى "cancelled"
```

### 3. **اختبار إرجاع المخزون**
```bash
# إنشاء طلب وتقليل مخزون منتج
# إلغاء الطلب
# التحقق من إرجاع المخزون
```

## ملاحظات مهمة:

1. **المهلة الزمنية**: يمكن تعديل المهلة من 48 ساعة في `CheckoutController.php`
2. **الأمان**: تأكد من حماية routes الخاصة بالدفع
3. **الإشعارات**: يمكن إضافة إشعارات للمستخدمين عند اقتراب انتهاء المهلة
4. **الـ Logging**: جميع عمليات الإلغاء التلقائي تُسجل في logs

## استكشاف الأخطاء:

### إذا لم تظهر الطلبات المعلقة:
1. تحقق من وجود `expires_at` في جدول orders
2. تأكد من أن الطلب يُنشأ بحالة "pending"
3. تحقق من permissions الـ API

### إذا لم يعمل الإلغاء التلقائي:
1. تأكد من تسجيل الـ command في Kernel.php
2. تحقق من تشغيل queue worker إذا كان الـ scheduler يستخدم queue
3. راجع logs للأخطاء

### إذا ظهر خطأ في إرجاع المخزون:
1. تحقق من وجود `stock_quantity` في جدول products
2. تأكد من أن الكميات موجبة
3. راجع database constraints